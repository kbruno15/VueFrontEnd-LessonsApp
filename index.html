<!DOCTYPE html> 
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>After School Lessons</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
</head>
<body>
  <div id="app" class="app-shell">
    <header class="app-header">
      <h1>After School Lessons</h1>

      <button
        class="cart-toggle-btn"
        :disabled="!showCart && cart.length === 0"
        @click="toggleView"
      >
        {{ showCart ? 'Back to Lessons' : 'Cart (' + cartItemCount + ')' }}
      </button>
    </header>

    <main class="app-main">
      <!-- Error banner -->
      <div v-if="errorMessage" class="banner banner-error">
        {{ errorMessage }}
      </div>
      <div v-if="submitMessage" class="banner banner-success">
        {{ submitMessage }}
      </div>

      <!-- LESSONS VIEW -->
      <section v-if="!showCart" class="lessons-view">
        <!-- Search -->
        <div class="toolbar">
          <input
            type="text"
            class="search-input"
            placeholder="Search by subject, location, price or spaces..."
            v-model="searchTerm"
            @input="onSearchInput"
          >

          <!-- Sort controls -->
          <div class="sort-controls">
            <div class="sort-group">
              <span class="sort-label">Sort by</span>
              <button
                class="sort-btn"
                :class="{ active: sortAttribute === 'subject' }"
                @click="setSort('subject')"
              >
                Subject
              </button>
              <button
                class="sort-btn"
                :class="{ active: sortAttribute === 'location' }"
                @click="setSort('location')"
              >
                Location
              </button>
              <button
                class="sort-btn"
                :class="{ active: sortAttribute === 'price' }"
                @click="setSort('price')"
              >
                Price
              </button>
              <button
                class="sort-btn"
                :class="{ active: sortAttribute === 'space' }"
                @click="setSort('space')"
              >
                Availability
              </button>
            </div>

            <div class="sort-group">
              <span class="sort-label">Order</span>
              <button
                class="sort-btn"
                :class="{ active: sortOrder === 'asc' }"
                @click="setSortOrder('asc')"
              >
                Ascending
              </button>
              <button
                class="sort-btn"
                :class="{ active: sortOrder === 'desc' }"
                @click="setSortOrder('desc')"
              >
                Descending
              </button>
            </div>
          </div>
        </div>

        <!-- Lesson cards -->
        <div class="lessons-grid">
          <article
            v-for="lesson in sortedLessons"
            :key="lesson._id"
            class="lesson-card"
          >
            <div class="lesson-icon">
              <span>{{ lesson.topic.charAt(0).toUpperCase() }}</span>
            </div>

            <div class="lesson-body">
              <h2 class="lesson-title">{{ lesson.topic }}</h2>
              <p class="lesson-meta">Location: <strong>{{ lesson.location }}</strong></p>
              <p class="lesson-meta">Price: <strong>£{{ lesson.price }}</strong></p>
              <p class="lesson-meta">Spaces: <strong>{{ lesson.space }}</strong></p>
            </div>

            <div class="lesson-actions">
              <button
                class="primary-btn"
                :disabled="lesson.space === 0"
                @click="addToCart(lesson)"
              >
                {{ lesson.space === 0 ? 'Full' : 'Add to cart' }}
              </button>
            </div>
          </article>
        </div>
      </section>

      <!-- CART VIEW -->
      <section v-else class="cart-view">
        <h2 class="section-title">Shopping Cart</h2>

        <div v-if="cart.length === 0" class="empty-cart">
          Your cart is empty.
        </div>

        <div v-else class="cart-grid">
          <article
            v-for="(item, index) in cart"
            :key="item._id"
            class="lesson-card"
          >
            <div class="lesson-icon">
              <span>{{ item.topic.charAt(0).toUpperCase() }}</span>
            </div>

            <div class="lesson-body">
              <h2 class="lesson-title">{{ item.topic }}</h2>
              <p class="lesson-meta">Location: <strong>{{ item.location }}</strong></p>
              <p class="lesson-meta">Price: <strong>£{{ item.price }}</strong></p>
              <p class="lesson-meta">Quantity: <strong>{{ item.quantity }}</strong></p>
              <p class="lesson-meta">Spaces left: <strong>{{ lessonSpace(item._id) }}</strong></p>
            </div>

            <div class="lesson-actions">
              <button class="secondary-btn" @click="removeFromCart(item, index)">
                Remove
              </button>
            </div>
          </article>
        </div>

        <!-- Checkout -->
        <section class="checkout-section">
          <h2 class="section-title">Checkout</h2>

          <form class="checkout-form" @submit.prevent="submitOrder">
            <div class="form-row">
              <label for="name">Name</label>
              <input
                id="name"
                type="text"
                v-model="name"
                :class="{ invalid: name && !isNameValid }"
                placeholder="Student / parent name"
              >
              <small v-if="name && !isNameValid" class="error-text">
                Name must contain letters and spaces only.
              </small>
            </div>

            <div class="form-row">
              <label for="phone">Phone</label>
              <input
                id="phone"
                type="text"
                v-model="phone"
                :class="{ invalid: phone && !isPhoneValid }"
                placeholder="Digits only"
              >
              <small v-if="phone && !isPhoneValid" class="error-text">
                Phone must contain digits only.
              </small>
            </div>

            <div class="form-actions">
              <button
                type="submit"
                class="primary-btn checkout-btn"
                :disabled="!canCheckout"
              >
                {{ isSubmitting ? 'Processing...' : 'Checkout' }}
              </button>
            </div>
          </form>
        </section>
      </section>
    </main>
  </div>

  <script>
    var API_BASE = 'http://localhost:3000';

    new Vue({
      el: '#app',
      data: {
        lessons: [],
        cart: [],
        sortAttribute: 'subject',
        sortOrder: 'asc',
        showCart: false,
        name: '',
        phone: '',
        searchTerm: '',
        isSubmitting: false,
        submitMessage: '',
        errorMessage: ''
      },
      created: function () {
        this.fetchLessons();
      },
      computed: {
        sortedLessons: function () {
          var lessonsCopy = this.lessons.slice();
          var attr = this.sortAttribute;
          var orderFactor = this.sortOrder === 'asc' ? 1 : -1;

          return lessonsCopy.sort(function (a, b) {
            var valA, valB;

            if (attr === 'subject') {
              valA = a.topic.toLowerCase();
              valB = b.topic.toLowerCase();
            } else if (attr === 'location') {
              valA = a.location.toLowerCase();
              valB = b.location.toLowerCase();
            } else if (attr === 'price') {
              valA = a.price;
              valB = b.price;
            } else { // space
              valA = a.space;
              valB = b.space;
            }

            if (valA < valB) return -1 * orderFactor;
            if (valA > valB) return 1 * orderFactor;
            return 0;
          });
        },
        cartItemCount: function () {
          return this.cart.reduce(function (total, item) {
            return total + item.quantity;
          }, 0);
        },
        isNameValid: function () {
          var pattern = /^[A-Za-z\s]+$/;
          return pattern.test(this.name.trim());
        },
        isPhoneValid: function () {
          var pattern = /^[0-9]+$/;
          return pattern.test(this.phone.trim());
        },
        canCheckout: function () {
          return (
            this.cart.length > 0 &&
            this.isNameValid &&
            this.isPhoneValid &&
            !this.isSubmitting
          );
        }
      },
      methods: {
        fetchLessons: function () {
          var self = this;
          fetch(API_BASE + '/lessons')
            .then(function (res) {
              return res.json();
            })
            .then(function (data) {
              self.lessons = data;
            })
            .catch(function (err) {
              console.error(err);
              self.errorMessage = 'Failed to load lessons from server.';
            });
        },
        onSearchInput: function () {
          var self = this;

          if (!this.searchTerm) {
            this.fetchLessons();
            return;
          }

          fetch(API_BASE + '/search?q=' + encodeURIComponent(this.searchTerm))
            .then(function (res) { return res.json(); })
            .then(function (data) {
              self.lessons = data;
            })
            .catch(function (err) {
              console.error(err);
              self.errorMessage = 'Search request failed.';
            });
        },
        setSort: function (attr) {
          this.sortAttribute = attr;
        },
        setSortOrder: function (order) {
          this.sortOrder = order;
        },
        addToCart: function (lesson) {
          if (lesson.space <= 0) {
            return;
          }
          lesson.space -= 1;

          var existing = this.cart.find(function (item) {
            return item._id === lesson._id;
          });

          if (existing) {
            existing.quantity += 1;
          } else {
            this.cart.push({
              _id: lesson._id,
              topic: lesson.topic,
              location: lesson.location,
              price: lesson.price,
              quantity: 1
            });
          }
        },
        removeFromCart: function (item, index) {
          var self = this;
          var lesson = this.lessons.find(function (l) {
            return l._id === item._id;
          });

          if (lesson) {
            lesson.space += item.quantity;
          }

          this.cart.splice(index, 1);
        },
        toggleView: function () {
          this.showCart = !this.showCart;
          this.submitMessage = '';
          this.errorMessage = '';
        },
        lessonSpace: function (lessonId) {
          var lesson = this.lessons.find(function (l) {
            return l._id === lessonId;
          });
          return lesson ? lesson.space : 0;
        },
        submitOrder: function () {
          var self = this;
          if (!this.canCheckout) {
            return;
          }

          this.isSubmitting = true;
          this.submitMessage = '';
          this.errorMessage = '';

          var payload = {
            name: this.name.trim(),
            phone: this.phone.trim(),
            items: this.cart.map(function (item) {
              return {
                lessonId: item._id,
                quantity: item.quantity
              };
            })
          };

          // POST order
          fetch(API_BASE + '/orders', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          })
            .then(function (res) {
              if (!res.ok) {
                throw new Error('Order request failed');
              }
              return res.json();
            })
            .then(function () {
              // PUT updated spaces for each lesson
              var updatePromises = self.cart.map(function (item) {
                var lesson = self.lessons.find(function (l) {
                  return l._id === item._id;
                });
                if (!lesson) return Promise.resolve();

                return fetch(API_BASE + '/lessons/' + item._id, {
                  method: 'PUT',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ space: lesson.space })
                });
              });

              return Promise.all(updatePromises);
            })
            .then(function () {
              self.submitMessage = 'Order submitted successfully.';
              self.cart = [];
              self.name = '';
              self.phone = '';
            })
            .catch(function (err) {
              console.error(err);
              self.errorMessage = 'Failed to submit order. Please try again.';
            })
            .finally(function () {
              self.isSubmitting = false;
            });
        }
      }
    });
  </script>
</body>
</html>
