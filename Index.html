<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>After School Lessons</title>

  <!-- Bootstrap -->
  <link rel="stylesheet"
        href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">

  <!-- Font Awesome for icons -->
  <link rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

  <!-- Custom Styles -->
  <link rel="stylesheet" href="style.css">

  <!-- Vue 2 -->
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
</head>
<body>
<div id="app" class="app-wrapper">

  <h1 class="page-title">After School Lessons</h1>

  <!-- Top bar: cart button -->
  <div class="top-bar">
    <button class="btn btn-cart"
            :disabled="cart.length === 0"
            @click="toggleCart">
      <i class="fa fa-shopping-cart me-2"></i>
      {{ showCart ? 'Back to Lessons' : 'Shopping Cart (' + totalCartItems + ')' }}
    </button>
  </div>

  <!-- LESSONS PAGE -->
  <div v-if="!showCart">

    <!-- Search -->
    <div class="search-section">
      <input type="text"
             class="form-control search-input"
             placeholder="Search lessons (subject, location, price, spaces)..."
             v-model="searchQuery"
             @input="onSearchInput">
      <small class="text-muted" v-if="searchStatus">{{ searchStatus }}</small>
    </div>

    <!-- Sort controls -->
    <div class="sort-section">
      <div class="sort-box">
        <div class="sort-title">Sort by</div>
        <label class="sort-option">
          <input type="radio" value="topic" v-model="sortAttribute">
          Subject
        </label>
        <label class="sort-option">
          <input type="radio" value="location" v-model="sortAttribute">
          Location
        </label>
        <label class="sort-option">
          <input type="radio" value="price" v-model="sortAttribute">
          Price
        </label>
        <label class="sort-option">
          <input type="radio" value="space" v-model="sortAttribute">
          Availability
        </label>
      </div>

      <div class="sort-box">
        <div class="sort-title">Order</div>
        <label class="sort-option">
          <input type="radio" value="asc" v-model="sortOrder">
          Ascending
        </label>
        <label class="sort-option">
          <input type="radio" value="desc" v-model="sortOrder">
          Descending
        </label>
      </div>
    </div>

    <!-- Lessons list -->
    <div class="lessons-grid">
      <div class="lesson-card"
           v-for="lesson in sortedLessons"
           :key="lesson._id">
        <div class="lesson-content">
          <div class="lesson-text">
            <div><span class="label">Subject:</span> {{ lesson.topic }}</div>
            <div><span class="label">Location:</span> {{ lesson.location }}</div>
            <div><span class="label">Price:</span> £{{ lesson.price }}</div>
            <div><span class="label">Spaces:</span> {{ lesson.space }}</div>
          </div>
          <div class="lesson-icon-wrapper">
            <i class="lesson-icon"
               :class="topicIcon(lesson.topic)"></i>
          </div>
        </div>
        <button class="btn btn-add"
                :disabled="lesson.space === 0"
                @click="addToCart(lesson)">
          Add to cart
        </button>
      </div>
    </div>

  </div>

  <!-- CART PAGE -->
  <div v-else>

    <h2 class="section-heading">Shopping Cart</h2>

    <div v-if="cart.length === 0" class="empty-cart">
      Your cart is empty.
    </div>

    <div class="cart-grid" v-if="cart.length > 0">
      <div class="cart-card"
           v-for="item in cart"
           :key="item.lesson._id">
        <div class="lesson-content">
          <div class="lesson-text">
            <div><span class="label">Subject:</span> {{ item.lesson.topic }}</div>
            <div><span class="label">Location:</span> {{ item.lesson.location }}</div>
            <div><span class="label">Price:</span> £{{ item.lesson.price }}</div>
            <div><span class="label">Quantity:</span> {{ item.quantity }}</div>
          </div>
          <div class="lesson-icon-wrapper">
            <i class="lesson-icon" :class="topicIcon(item.lesson.topic)"></i>
          </div>
        </div>
        <button class="btn btn-remove"
                @click="removeFromCart(item.lesson)">
          Remove
        </button>
      </div>
    </div>

    <!-- CHECKOUT SECTION -->
    <h2 class="section-heading">Checkout</h2>

    <div class="checkout-section">
      <div class="checkout-field">
        <label class="form-label">Name:</label>
        <input type="text" class="form-control"
               v-model="checkoutName">
        <div class="error-text" v-if="checkoutName && !validName">
          Name must contain letters and spaces only.
        </div>
      </div>
      <div class="checkout-field">
        <label class="form-label">Phone:</label>
        <input type="text" class="form-control"
               v-model="checkoutPhone">
        <div class="error-text" v-if="checkoutPhone && !validPhone">
          Phone must contain digits only.
        </div>
      </div>
      <div class="checkout-button-wrapper">
        <button class="btn btn-checkout"
                :disabled="checkoutDisabled"
                @click="submitOrder">
          Checkout
        </button>
      </div>
    </div>

    <div v-if="checkoutMessage" class="alert alert-success mt-3">
      {{ checkoutMessage }}
    </div>

  </div>
</div>

<script>
  // Backend URL
  var API_BASE = '';

  new Vue({
    el: '#app',
    data: {
      lessons: [],
      cart: [],
      showCart: false,

      sortAttribute: 'price',
      sortOrder: 'asc',

      searchQuery: '',
      searchStatus: '',

      checkoutName: '',
      checkoutPhone: '',
      checkoutMessage: ''
    },

    created: function () {
      this.fetchLessons();
    },

    computed: {
      totalCartItems: function () {
        return this.cart.reduce(function (sum, item) {
          return sum + item.quantity;
        }, 0);
      },
      validName: function () {
        return /^[A-Za-z\s]+$/.test(this.checkoutName);
      },
      validPhone: function () {
        return /^\d+$/.test(this.checkoutPhone);
      },
      checkoutDisabled: function () {
        return !(this.cart.length > 0 && this.validName && this.validPhone);
      },
      sortedLessons: function () {
        var arr = this.lessons.slice();
        var attr = this.sortAttribute;
        var order = this.sortOrder;

        arr.sort(function (a, b) {
          var x = a[attr];
          var y = b[attr];
          if (typeof x === 'string') x = x.toLowerCase();
          if (typeof y === 'string') y = y.toLowerCase();
          if (x < y) return order === 'asc' ? -1 : 1;
          if (x > y) return order === 'asc' ? 1 : -1;
          return 0;
        });

        return arr;
      }
    },

    methods: {
      topicIcon: function (topic) {
        var t = (topic || '').toLowerCase();
        if (t.indexOf('math') !== -1) return 'fa-solid fa-calculator';
        if (t.indexOf('music') !== -1) return 'fa-solid fa-music';
        if (t.indexOf('english') !== -1) return 'fa-solid fa-pen';
        return 'fa-solid fa-book';
      },
      toggleCart: function () {
        this.showCart = !this.showCart;
      },
      fetchLessons: function () {
        var self = this;
        self.searchStatus = 'Loading lessons...';
        fetch(API_BASE + '/lessons')
          .then(function (res) { return res.json(); })
          .then(function (data) {
            self.lessons = data;
            self.searchStatus = 'Loaded ' + data.length + ' lessons.';
          })
          .catch(function () {
            self.searchStatus = 'Error loading lessons.';
          });
      },
      onSearchInput: function () {
        var self = this;
        var q = self.searchQuery.trim();
        if (!q) {
          this.fetchLessons();
          return;
        }
        self.searchStatus = 'Searching...';
        fetch(API_BASE + '/search?q=' + encodeURIComponent(q))
          .then(function (res) { return res.json(); })
          .then(function (data) {
            self.lessons = data;
            self.searchStatus = 'Found ' + data.length + ' lessons for "' + q + '"';
          })
          .catch(function () {
            self.searchStatus = 'Error while searching.';
          });
      },
      addToCart: function (lesson) {
        if (lesson.space === 0) return;
        var existing = this.cart.find(function (item) {
          return item.lesson._id === lesson._id;
        });
        if (existing) {
          existing.quantity += 1;
        } else {
          this.cart.push({ lesson: lesson, quantity: 1 });
        }
        lesson.space -= 1;
      },
      removeFromCart: function (lesson) {
        var index = -1;
        this.cart.forEach(function (item, i) {
          if (item.lesson._id === lesson._id) {
            index = i;
            lesson.space += item.quantity;
          }
        });
        if (index !== -1) {
          this.cart.splice(index, 1);
        }
      },
      submitOrder: function () {
        var self = this;
        if (this.checkoutDisabled) return;

        var payload = {
          name: this.checkoutName,
          phone: this.checkoutPhone,
          items: this.cart.map(function (item) {
            return {
              lessonId: item.lesson._id,
              quantity: item.quantity
            };
          })
        };

        fetch(API_BASE + '/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
          .then(function (res) { return res.json(); })
          .then(function (data) {
            if (data.error) throw new Error(data.error);
            var updatePromises = self.cart.map(function (item) {
              return fetch(API_BASE + '/lessons/' + item.lesson._id, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ space: item.lesson.space })
              });
            });
            return Promise.all(updatePromises);
          })
          .then(function () {
            self.checkoutMessage = 'Order submitted successfully!';
            self.cart = [];
            self.checkoutName = '';
            self.checkoutPhone = '';
          })
          .catch(function () {
            self.checkoutMessage = 'Error submitting order. Please try again.';
          });
      }
    }
  });
</script>
</body>
</html>